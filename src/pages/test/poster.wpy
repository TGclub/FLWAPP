<style lang="scss" type="text/scss">
	@import "../../common/styles/mixins";
	@import "../../common/styles/variables";
	@import "../../common/styles/common";

	.canvasBox {

	}

	.canvasMain {
		width:1654px;

		position: absolute;
	}

	.musk{
		position: fixed;
		z-index: 21;
		height: 100%;
		width: 750rpx;
		background: rgb(0,0,0);
	}
	.img {
		position: fixed;
		height: 100%;
		width: 750rpx;
		z-index: 22;
	}

	.btn{
		position: fixed;
		bottom: 40rpx;
		z-index: 23;
		left: 246rpx;
	}
</style>
<template>
	<div class="musk"></div>
	<button @tap="saveToAlbum" class="btn">保存到相册</button>
	<div class="canvasBox">
		<!-- positon 如果不为fixed的话 显示不全 因为overflow hidden了-->
			<canvas  class="canvasMain" style="height: {{height}}px" canvas-id="poster"/>
		<!--<canvas style="width:375px;height: 667px;" canvas-id="poster"/>-->
	</div>
	<image src="{{imagePath}}" class="img"></image>
</template>

<script>
	/*eslint-disable */
	import page from '../base/basicPage.wpy'

	export default class TestPage extends page {
		components = {}
		config = {
			enablePullDownRefresh: false,
			navigationBarTitleText: '捐赠证书'
		}

		methods = {}
		data = {
			donateName: '',
			imgURL: '',
			painting: null,
			imagePath: '',
			isNotOK: false,
			height:2339
		}

		onShow () {
		}

		saveToAlbum () {
			var that = this
			that.$WX.toast('请等待')
			wx.getSetting({
				success (res) {
					if (!res.authSetting['scope.writePhotosAlbum']) {
						wx.authorize({
							scope: 'scope.writePhotosAlbum',
							success () {
								wx.saveImageToPhotosAlbum({
									filePath: that.imagePath,
									success (res) {
										wx.showModal({
											content: '图片已保存到相册，赶紧晒一下吧~',
											showCancel: false,
											confirmText: '好的',
											confirmColor: '#333',
											success: function (res) {
												if (res.confirm) {
													console.log('用户点击确定');
												}
											},
											fail:function(res){
												console.log(11111)
											}
										})
									},
									fail (err) {
										console.log(err)
									}
								})
							},
							fail (err) {
								console.log(err)
							}
						})
					} else  {
						wx.saveImageToPhotosAlbum({
							filePath: that.imagePath,
							success (res) {
								wx.showModal({
									content: '证书已保存到相册，赶紧晒一下吧~',
									showCancel: false,
									confirmText: '好的',
									confirmColor: '#333',
									success: function (res) {
										if (res.confirm) {
											console.log('用户点击确定');
										}
									},
									fail:function(res){
										console.log(11111)
									}
								})
							},
							fail (err) {
								console.log(err)
							}
						})
					}
				}
			})
		}

		downloadFile (cb) {
			const self = this
			wx.downloadFile({
				url: 'https://api.helloyzy.cn/post2.jpeg',
				success: function (res) {
					if (res.statusCode === 200) {
						console.log(res)
						self.imgURL = res.tempFilePath
						cb();
					}
				}
			})
		}

		onLoad () {
			this.data.donateName = this.$WX.getStorage('donate_name')
			console.log(this.data.donateName)
			this.$WX.showLoading('生成捐赠证书中')
			this.downloadFile(() => {
				this.createPoster(this.data.donateName)
			})

		}

		createPoster (name) {
			const that = this;
			const bgImg = this.imgURL;
			const baseRate = 2.15;
			const ctx = wx.createCanvasContext('poster')
			const time = new Date()
			const year = time.getFullYear()
			const month = time.getMonth() + 1
			const date = time.getDate()
			ctx.drawImage(bgImg, 0, 0, 1654/ baseRate, 2339/ baseRate)
			// ctx.drawImage(bgImg, 0, 0, 375, 667)
			ctx.setFontSize(32 / baseRate)
			ctx.setFillStyle('#333333')
			ctx.setTextAlign('center')
			ctx.setFillStyle('#333333')
			ctx.setTextAlign('center')
			ctx.fillText(name, 803 / baseRate , 974 / baseRate)
			ctx.fillText(year, 730 / baseRate, 2058 / baseRate) // 42
			ctx.fillText(month, 842/ baseRate, 2058/ baseRate)
			ctx.fillText(date, 933/ baseRate, 2058/ baseRate)
			ctx.stroke()
			ctx.draw(true, () => {
				wx.canvasToTempFilePath({
					canvasId: 'poster',
					destHeight: 2339 / baseRate,
					height: 2339 / baseRate,
					width: 1654 / baseRate,
					destWidth: 1654 / baseRate,
					success: function (res) {
						let tempFilePath = res.tempFilePath
						that.imagePath = tempFilePath
						that.$WX.hideLoading();
						that.isNotOK = false
						that.height = 0
						that.$apply();
						console.log('绘制完成！', tempFilePath)
					},
					fail: function (res) {
						console.log(res)
					}
				})
			})
		}
	}
</script>
